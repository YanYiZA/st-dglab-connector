# DG-Lab Connector for SillyTavern

这是一个 **SillyTavern** 的扩展插件，允许 AI 角色通过文本指令控制 **DG-Lab 郊狼** 电击设备。

---

## 🔌 工作原理

插件通过监听 SillyTavern 的消息接收事件，实时分析 AI 输出的内容。当检测到特定的控制标签（如 `[DG:50]`）时，插件会通过本地运行的 DG-Lab Hub API 向指定的设备发送强度指令。

### 核心流程
1.  **消息监听**：插件挂载到 SillyTavern 的 `MESSAGE_RECEIVED` 事件。
2.  **指令解析**：使用正则表达式扫描消息内容，提取 `[DG:强度]` 或 `[DG:强度:持续时间]` 格式的标签。
3.  **强度计算**：
    *   插件会自动从 Hub 获取设备当前的物理强度限制（例如 `20`）。
    *   AI 输出的数值被视为百分比 (0-100%)。
    *   **实际发送强度** = `(AI数值 / 100) * 自动获取的最大强度`。
    *   *例如：设备限制为 20，AI 输出 `[DG:50]`，实际发送强度为 10。*
4.  **指令发送**：通过 HTTP POST 请求将计算后的强度值发送到 DG-Lab Hub API (默认 `http://127.0.0.1:8920`)。
5.  **队列处理**：如果一条消息中包含多个指令，插件会按顺序依次执行。

---

## 🛠️ 使用方法

### 1. 环境准备
- 在SillyTavern安装该扩展
- 确保已安装并运行 **DG-Lab Hub** (或其他兼容的 WebSocket/HTTP 桥接服务)。
- 确保 **DG-Lab 设备** 已连接到 Hub。
- 安装并启用 Chrome 插件 **Moesif Origin/CORS Changer & API Logger** 以解决 CORS 问题。

### 2. 插件设置
在 SillyTavern 的扩展设置面板中找到 **DG-Lab Connector**：
- **连接状态**：面板顶部显示当前连接状态及获取到的最大强度。
    - 🟢 **已连接**：正常工作，显示当前最大强度限制。
    - 🔴 **未连接**：请检查 Hub 是否运行或 Target ID 是否正确。
- **启用插件**：开启或关闭功能。
- **覆盖旧指令**：开启后，新指令会清空队列中积压的旧指令，优先执行最新反馈。
- **Hub API URL**：DG-Lab Hub 的地址，默认为 `http://127.0.0.1:8920`。
- **Target ID**：目标设备的 ID，即HUB中显示的客户端ID。

### 3. AI 指令格式
在角色的回复或世界书/Prompt 中使用以下格式：

| 格式 | 描述 | 示例 |
| :--- | :--- | :--- |
| `[DG:50]` | 以 50% 的强度电击，默认持续 5 秒 | `[DG:50]` |
| `[DG:100:2]` | 以 100% 的强度电击，持续 2 秒 | `[DG:100:2]` |

### 4. 示例
如果你的设备最大强度限制为 **20**：
- AI 回复：“受到惩罚吧！[DG:80]”
- -> 设备将收到强度 **16** 的指令 (20 * 0.8)。

---

## ⚠️ 免责声明
本插件仅供娱乐和学习使用。请务必在安全范围内使用电击设备，并对自己的身体承受能力有充分认知。开发者不对因使用本插件造成的任何身体伤害或设备损坏负责。
